name: GitGuardian Secrets Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  ggshield_scan:
    name: GitGuardian CI Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitGuardian Scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

      - name: Annotate failure
        if: failure()
        run: echo "❌ GitGuardian wykrył sekret w repozytorium!"

  security-gate:
    name: Security Gate (Merge blocker)
    needs: ggshield_scan
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Block PR if secret found
        run: |
          if [ "${{ needs.ggshield_scan.result }}" == "failure" ]; then
            echo "❌ Sekrety wykryte! Merge zablokowany."
            exit 1
          else
            echo "✅ Brak sekretów – możesz mergeować PR."
          fi

      - name: Comment PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
                **GitGuardian wykrył wyciek sekretów!**
                Pipeline został zatrzymany.

                **Jak naprawić problem?**
                1. Usuń sekret z kodu
                2. Zrotuj klucz/token
                3. Dodaj go do GitHub Secrets / Vault
                4. Wykonaj ponowny commit bez sekretu
              `
            })
