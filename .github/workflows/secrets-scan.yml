name: GitGuardian Secrets Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write 
  security-events: write

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Run GitGuardian Scan (SARIF output)
        uses: GitGuardian/ggshield-action@v1
        with:
          args: scan ci --format sarif --output ggshield-report.sarif
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true 

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ggshield-report.sarif

      #znalezione sekrety w kontekscie pull_request
      - name: Comment on PR with Remediation
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
                ### üõ°Ô∏è Security Alert: Wykryto sekrety!
                Pipeline zosta≈Ç zatrzymany, aby zapobiec wyciekowi danych.

                **Co zosta≈Ço znalezione?**
                Sprawd≈∫ zak≈Çadkƒô "Files changed" lub logi powy≈ºej, aby zobaczyƒá szczeg√≥≈Çy.

                **Instrukcja naprawy (Remediation):**
                1. **NIE** usuwaj tylko tekstu w nowym commicie (sekret zostanie w historii gita!).
                2. Zrotuj (zmie≈Ñ) ujawnione has≈Ço/klucz - uznaj je za spalone.
                3. U≈ºyj \`git filter-repo\` lub BFG, je≈õli sekret trafi≈Ç do historii, lub po prostu usu≈Ñ go z bie≈ºƒÖcych zmian przed pushem (je≈õli to tylko PR).
                4. Dodaj sekret do GitHub Secrets lub Vaulta.
              `
            })